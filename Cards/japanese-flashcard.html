<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a2e">
<title>æ—¥æœ¬èª ë‹¨ì–´ì¥</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icon.svg">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; -webkit-text-size-adjust:100%; text-size-adjust:100%; }
:root {
  --bg: #1a1a2e; --bg-card: #16213e; --bg-inner: #0f3460;
  --accent: #e94560; --accent-soft: #ff6b6b; --accent-glow: rgba(233,69,96,0.3);
  --text: #eaeaea; --muted: #8892b0; --success: #00d2d3;
  --day-active: #e94560; --day-inactive: #233554;
}
html { height:var(--app-h,100vh); overflow:hidden; overscroll-behavior:none; }
body {
  height:var(--app-h,100vh); background:linear-gradient(135deg,var(--bg) 0%,#16213e 50%,#0f3460 100%);
  font-family:'Noto Sans KR',sans-serif; color:var(--text);
  display:flex; flex-direction:column; align-items:center;
  overflow:hidden; user-select:none; overscroll-behavior:none;
  padding-bottom:env(safe-area-inset-bottom,0px);
}
#app {
  width:100%; max-width:480px; height:100%;
  display:flex; flex-direction:column; align-items:center;
  overflow:hidden;
}
.header {
  width:100%; padding:10px 16px 4px;
  display:flex; justify-content:space-between; align-items:center; flex-shrink:0;
}
.logo { font-size:22px; font-weight:900; color:var(--accent); font-family:'Noto Sans JP',sans-serif; }
.logo-sub { font-size:13px; color:var(--muted); font-weight:300; margin-left:8px; }
.test-btn {
  background:var(--accent); border:none; border-radius:20px; padding:6px 14px;
  color:#fff; font-size:12px; font-weight:700; cursor:pointer;
  font-family:'Noto Sans KR',sans-serif; transition:all .2s;
}
.test-btn.disabled { background:var(--day-inactive); cursor:default; }
.days {
  width:100%; padding:4px 16px;
  display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; flex-shrink:0;
}
.days::-webkit-scrollbar { display:none; }
.day-btn {
  flex:0 0 auto; border-radius:10px; padding:6px 12px;
  font-size:11px; cursor:pointer; transition:all .3s;
  font-family:'Noto Sans KR',sans-serif; border:2px solid transparent;
  background:var(--day-inactive); color:var(--muted); font-weight:400;
}
.day-btn.active {
  background:var(--day-active); color:#fff; font-weight:700;
  border-color:var(--accent); box-shadow:0 0 15px var(--accent-glow);
}
.info {
  width:100%; padding:2px 16px 4px;
  font-size:12px; color:var(--muted); font-weight:300; flex-shrink:0;
}
.card-area {
  width:calc(100% - 32px); max-width:440px; flex:1; min-height:0;
  background:linear-gradient(145deg,var(--bg-inner),var(--bg-card));
  border-radius:20px; margin:4px 0; padding:24px 20px 16px;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
  box-shadow:0 20px 60px rgba(0,0,0,.4),0 0 40px var(--accent-glow);
  border:1px solid rgba(233,69,96,.15); position:relative;
  transition:transform .25s ease, opacity .25s ease;
}
.card-area.slide-left {
  animation:slideLeft .25s ease;
}
.card-area.slide-right {
  animation:slideRight .25s ease;
}
@keyframes slideLeft {
  0% { transform:translateX(60px); opacity:0; }
  100% { transform:translateX(0); opacity:1; }
}
@keyframes slideRight {
  0% { transform:translateX(-60px); opacity:0; }
  100% { transform:translateX(0); opacity:1; }
}
.bookmark-btn {
  position:absolute; top:16px; right:16px; background:none; border:none;
  font-size:24px; cursor:pointer; color:var(--muted); transition:all .2s; z-index:10;
}
.bookmark-btn.active { color:var(--success); filter:drop-shadow(0 0 6px rgba(0,210,211,.4)); }
.difficult-btn {
  position:absolute; top:16px; right:52px; background:none; border:none;
  font-size:22px; cursor:pointer; color:var(--muted); transition:all .2s; z-index:10;
}
.difficult-btn.active { color:#ffd700; filter:drop-shadow(0 0 6px rgba(255,215,0,.4)); }
.play-dots {
  position:absolute; top:16px; left:16px; display:flex; gap:4px;
}
.dot {
  width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,.15); transition:background .3s;
}
.dot.filled { background:var(--accent); }
.hiragana {
  font-size:72px; font-weight:700; color:#fff;
  font-family:'Noto Sans JP',sans-serif; letter-spacing:4px;
  text-shadow:0 0 30px var(--accent-glow); line-height:1.3; text-align:center;
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
}
.hiragana.small { font-size:54px; }
.kanji-sub {
  font-size:20px; color:var(--muted); font-weight:400; letter-spacing:2px;
  margin-top:4px; opacity:.7;
}
.romaji { font-size:16px; color:var(--muted); font-weight:300; letter-spacing:2px; }
.meaning {
  font-size:18px; font-weight:500; color:var(--text); border-radius:8px;
  padding:8px 20px; cursor:pointer; transition:all .3s; text-align:center; min-width:120px;
}
.meaning.hidden { color:transparent; background:rgba(255,255,255,.08); }
.example-area { display:flex; align-items:center; justify-content:center; gap:6px; margin:8px 0 4px; }
.example-speak { position:relative; flex:0 0 auto; background:none; border:none; color:var(--accent); font-size:16px; cursor:pointer; padding:0; width:24px; height:24px; display:flex; align-items:center; justify-content:center; transition:color .2s; }
.example-speak::before { content:""; position:absolute; inset:-16px; }
.example-speak:active { opacity:.5; }
.example-speak.speaking { color:#ffd700; animation:ex-pulse .8s ease-in-out infinite; }
@keyframes ex-pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
.example-text { text-align:center; pointer-events:none; }
.example-jp { font-size:14px; color:var(--accent); }
.example-meaning { font-size:12px; color:var(--muted); margin-top:2px; }
.card-bottom {
  flex-shrink:0; display:flex; flex-direction:column; align-items:center; gap:4px;
}
.controls {
  width:100%; padding:8px 16px;
  display:flex; justify-content:space-between; align-items:center; flex-shrink:0;
}
.ctrl-col { display:flex; flex-direction:column; align-items:center; gap:2px; }
.speed-btn {
  background:none; border:none; color:var(--text);
  font-size:18px; font-weight:700; cursor:pointer; font-family:'Noto Sans KR',sans-serif;
}
.speed-label { font-size:10px; color:var(--muted); }
.play-btn {
  width:56px; height:56px; border-radius:50%; border:none;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:22px; color:#fff; transition:all .2s;
  background:linear-gradient(135deg,var(--accent),#c0392b);
  box-shadow:0 4px 25px var(--accent-glow);
}
.play-btn.playing { background:linear-gradient(135deg,var(--accent),var(--accent-soft)); }
.play-icon { display:block; width:0; height:0; border-style:solid; border-width:10px 0 10px 18px; border-color:transparent transparent transparent #fff; margin-left:3px; }
.pause-icon { display:flex; gap:5px; align-items:center; }
.pause-icon span { display:block; width:5px; height:20px; background:#fff; border-radius:1px; }
.eye-btn { background:none; border:none; font-size:22px; cursor:pointer; }
.eye-btn.off { filter:grayscale(1) opacity(.4); }
.progress-bar {
  width:calc(100% - 32px); max-width:440px; height:3px;
  background:rgba(255,255,255,.06); border-radius:2px; overflow:hidden; margin:2px 0 4px; flex-shrink:0;
}
.progress-fill {
  height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-soft));
  border-radius:2px; transition:width .3s;
}
.nav-row {
  width:100%; padding:0 16px 8px;
  display:flex; justify-content:space-between; flex-shrink:0;
}
.nav-btn {
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  border-radius:10px; padding:8px 20px; color:var(--muted);
  font-size:13px; cursor:pointer; font-family:'Noto Sans KR',sans-serif;
}
.test-actions { display:flex; gap:16px; margin-top:8px; }
.test-wrong {
  background:rgba(233,69,96,.2); border:2px solid var(--accent);
  border-radius:16px; padding:12px 28px; color:var(--accent);
  font-size:16px; font-weight:700; cursor:pointer; font-family:'Noto Sans KR',sans-serif;
}
.test-correct {
  background:rgba(0,210,211,.2); border:2px solid var(--success);
  border-radius:16px; padding:12px 28px; color:var(--success);
  font-size:16px; font-weight:700; cursor:pointer; font-family:'Noto Sans KR',sans-serif;
}
.result-page {
  width:100%; max-width:480px; padding:60px 20px; text-align:center;
  display:flex; flex-direction:column; align-items:center; gap:20px;
}
.result-emoji { font-size:48px; }
.result-title { font-size:24px; font-weight:700; }
.result-scores { display:flex; gap:30px; font-size:20px; font-weight:500; }
.result-hint { font-size:14px; color:var(--muted); line-height:1.6; }
.result-btns { display:flex; gap:12px; margin-top:10px; }
.result-retry {
  background:var(--accent); border:none; border-radius:12px;
  padding:12px 24px; color:#fff; font-size:14px; font-weight:700;
  cursor:pointer; font-family:'Noto Sans KR',sans-serif;
}
.result-back {
  background:var(--day-inactive); border:none; border-radius:12px;
  padding:12px 24px; color:#fff; font-size:14px; font-weight:500;
  cursor:pointer; font-family:'Noto Sans KR',sans-serif;
}
.back-link {
  background:none; border:none; color:var(--muted); font-size:14px;
  cursor:pointer; font-family:'Noto Sans KR',sans-serif;
}
.test-header {
  width:100%; padding:8px 16px; flex-shrink:0;
  display:flex; justify-content:space-between; align-items:center;
}
.gear-btn { background:none; border:none; font-size:22px; cursor:pointer; opacity:.6; transition:opacity .2s; }
.gear-btn:active { opacity:1; }
.settings-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100;
  display:flex; align-items:flex-end; justify-content:center;
}
.settings-panel {
  width:100%; max-width:480px; background:var(--bg-card);
  border-radius:20px 20px 0 0; padding:20px 24px 32px;
  border-top:1px solid rgba(233,69,96,.2);
  max-height:85vh; max-height:85dvh; overflow-y:auto;
}
.settings-title {
  font-size:16px; font-weight:700; color:var(--text); margin-bottom:16px;
  display:flex; justify-content:space-between; align-items:center;
}
.settings-close { background:none; border:none; color:var(--muted); font-size:20px; cursor:pointer; }
.settings-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 0; border-bottom:1px solid rgba(255,255,255,.06);
}
.settings-label { font-size:14px; color:var(--muted); }
.settings-value {
  display:flex; align-items:center; gap:8px;
}
.settings-input {
  width:60px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
  border-radius:8px; padding:6px 8px; color:var(--text); font-size:16px;
  text-align:center; font-family:'Noto Sans KR',sans-serif;
}
.settings-unit { font-size:12px; color:var(--muted); }
.menu-list {
  width:100%; flex:1; overflow-y:auto; padding:0 16px 16px;
  scrollbar-width:none;
}
.menu-list::-webkit-scrollbar { display:none; }
.menu-item {
  width:100%; background:linear-gradient(145deg,var(--bg-inner),var(--bg-card));
  border-radius:14px; padding:16px 18px; margin-bottom:10px;
  display:flex; justify-content:space-between; align-items:center;
  border:1px solid rgba(233,69,96,.1); cursor:pointer;
  transition:all .2s;
}
.menu-item:active { transform:scale(.98); border-color:var(--accent); }
.menu-item-left { display:flex; flex-direction:column; gap:4px; }
.menu-day {
  font-size:11px; color:var(--accent); font-weight:700; letter-spacing:1px;
}
.menu-title { font-size:15px; color:var(--text); font-weight:500; }
.menu-badge {
  background:rgba(233,69,96,.15); border-radius:10px; padding:4px 10px;
  font-size:12px; color:var(--accent-soft); font-weight:500; white-space:nowrap;
}
.menu-badge.clean { background:rgba(0,210,211,.1); color:var(--success); }
.menu-header {
  width:100%; padding:16px 16px 8px; flex-shrink:0;
}
.menu-header-title {
  font-size:24px; font-weight:900; color:var(--accent);
  font-family:'Noto Sans JP',sans-serif;
}
.menu-header-sub { font-size:13px; color:var(--muted); margin-top:4px; }
.refresh-btn {
  background:none; border:none; font-size:18px; cursor:pointer;
  color:var(--muted); margin-left:8px; transition:all .2s; vertical-align:middle;
}
.refresh-btn:active { color:var(--accent); transform:rotate(180deg); }
.cat-item {
  width:100%; background:linear-gradient(145deg,var(--bg-inner),var(--bg-card));
  border-radius:16px; padding:20px 20px; margin-bottom:12px;
  display:flex; justify-content:space-between; align-items:center;
  border:1px solid rgba(233,69,96,.15); cursor:pointer; transition:all .2s;
}
.cat-item:active { transform:scale(.98); border-color:var(--accent); }
.cat-title { font-size:18px; color:var(--text); font-weight:700; }
.cat-sub { font-size:12px; color:var(--muted); margin-top:4px; }
.cat-badge {
  background:rgba(233,69,96,.15); border-radius:12px; padding:6px 12px;
  font-size:13px; color:var(--accent-soft); font-weight:500; white-space:nowrap; text-align:center;
}
.cat-badge.clean { background:rgba(0,210,211,.1); color:var(--success); }
</style>
</head>
<body>

<div id="app"></div>
<div id="settings-root"></div>

<script>document.write('<script src="ê¸°ì´ˆë‹¨ì–´.js?_t=' + Date.now() + '"><\/script>');</script>
<script>document.write('<script src="ì¤‘ê¸‰ë‹¨ì–´.js?_t=' + Date.now() + '"><\/script>');</script>
<script>const WORD_DATA_MIKMAT = {};</script>
<script>for(let i=1;i<=13;i++){document.write('<script src="ë¯¸ì¹œë§›ì§‘/season1/ep'+String(i).padStart(2,'0')+'.js?_t='+Date.now()+'"><\/script>');}</script>
<script>
const APP_VERSION = "v26.02.16.23:34:54";

// === ì•ˆë“œë¡œì´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ë°” ëŒ€ì‘ ===
// window.innerHeightë¡œ ì‹¤ì œ ë³´ì´ëŠ” ì˜ì—­ì„ ì¸¡ì •í•˜ì—¬ CSS ë³€ìˆ˜ë¡œ ì„¤ì •
function setAppHeight() {
  document.documentElement.style.setProperty('--app-h', window.innerHeight + 'px');
}
setAppHeight();
window.addEventListener('resize', setAppHeight);
window.addEventListener('orientationchange', () => setTimeout(setAppHeight, 200));

// === DATA ===
// ê° ë‹¨ì–´ íŒŒì¼ì˜ ë°ì´í„°ë¥¼ WORD_DATAë¡œ í†µí•© (ì¹´í…Œê³ ë¦¬ë³„ ì˜¤í”„ì…‹ ì ìš©)
const WORD_DATA = {};
const CATEGORY_SOURCES = [
  { data: WORD_DATA_BASIC,        offset: 0   },
  { data: WORD_DATA_INTERMEDIATE, offset: 100 },
  { data: WORD_DATA_MIKMAT,       offset: 200 },
];
CATEGORY_SOURCES.forEach(src => {
  Object.keys(src.data).forEach(k => {
    WORD_DATA[Number(k) + src.offset] = src.data[k];
  });
});

const DAYS = Object.keys(WORD_DATA).map(Number).sort((a,b)=>a-b);

// ì¹´í…Œê³ ë¦¬ êµ¬ì¡°
const CATEGORIES = [
  { id: "basic", title: "ê¸°ì´ˆë‹¨ì–´", subtitle: "ì¸ì‚¬, ìˆ«ì, ëª…ì‚¬, ë™ì‚¬, í˜•ìš©ì‚¬, ìŒì‹, êµí†µ", days: DAYS.filter(d => d >= 1 && d <= 99) },
  { id: "intermediate", title: "ì¤‘ê¸‰ë‹¨ì–´", subtitle: "ê°ì •Â·ìƒíƒœ, ì§ì¥Â·ë¹„ì¦ˆë‹ˆìŠ¤", days: DAYS.filter(d => d >= 100 && d <= 199) },
  { id: "mikmat", title: "ë¯¸ì¹œë§›ì§‘ ì‹œì¦Œ1", subtitle: "ì—í”¼ì†Œë“œë³„ ë‹¨ì–´+í‘œí˜„", days: DAYS.filter(d => d >= 200 && d <= 299) },
];

// ê¸°ì¡´ jp-bm(ëª» ì™¸ìš´ ë‹¨ì–´) ë°ì´í„° ì •ë¦¬ â†’ ìƒˆ ì‹œìŠ¤í…œì€ jp-learned(ì™¸ìš´ ë‹¨ì–´)
if (localStorage.getItem("jp-bm")) localStorage.removeItem("jp-bm");

// === STATE ===
let state = {
  day: 1, idx: 0, playing: false, playCount: 0,
  showMeaning: true, showExample: localStorage.getItem("jp-show-example") !== "false",
  hideLearned: localStorage.getItem("jp-hide-learned") === "true",
  speed: 1.0, showSettings: false, slideDir: "",
  repeatDelay: Number(localStorage.getItem("jp-repeat-delay")) || 2400,
  repeatCount: Number(localStorage.getItem("jp-repeat-count")) || 3,
  fsMain: Number(localStorage.getItem("jp-fs-main")) || 72,
  fsReading: Number(localStorage.getItem("jp-fs-reading")) || 20,
  fsRomaji: Number(localStorage.getItem("jp-fs-romaji")) || 16,
  fsMeaning: Number(localStorage.getItem("jp-fs-meaning")) || 18,
  fsExample: Number(localStorage.getItem("jp-fs-example")) || 14,
  fsExampleM: Number(localStorage.getItem("jp-fs-example-m")) || 12,
  catIdx: 0, // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬
  mode: "categories", // categories | menu | study | test | result
  testWords: [], testIdx: 0, testRevealed: false,
  testScore: { correct: 0, wrong: 0 },
  bookmarks: JSON.parse(localStorage.getItem("jp-learned") || "{}"),
  difficult: JSON.parse(localStorage.getItem("jp-difficult") || "{}"),
  listenWords: [], listenIdx: 0,
  speakKorean: localStorage.getItem("jp-speak-korean") !== "false",
};

let playId = 0;

function saveBookmarks() { localStorage.setItem("jp-learned", JSON.stringify(state.bookmarks)); }
function getWords() {
  const all = WORD_DATA[state.day]?.words || [];
  if (state.hideLearned && state.mode === "study") {
    return all.filter(w => !state.bookmarks[bmKey(w)]);
  }
  return all;
}
function getAllWords() { return WORD_DATA[state.day]?.words || []; }
function getCurrent() {
  if (state.mode === "test") return state.testWords[state.testIdx];
  if (state.mode === "listening") return state.listenWords[state.listenIdx];
  return getWords()[state.idx];
}
function bmKey(w, day) { return (day||state.day) + "-" + w.h; }
function isBm(w) { return w ? !!state.bookmarks[bmKey(w)] : false; }
function bmCount() { return Object.keys(state.bookmarks).length; }
function unlearnedCount() {
  let c = 0;
  for (const d of DAYS) WORD_DATA[d].words.forEach(w => { if (!state.bookmarks[d+"-"+w.h]) c++; });
  return c;
}

// === ì–´ë ¤ìš´ ë‹¨ì–´ ===
function saveDifficult() { localStorage.setItem("jp-difficult", JSON.stringify(state.difficult)); }
function dfKey(w, day) { return (day||state.day) + "-" + w.h; }
function isDf(w, day) { return w ? !!state.difficult[dfKey(w, day)] : false; }
function getDifficultCount() { return Object.keys(state.difficult).length; }
function getDifficultWords() {
  const all = [];
  for (const d of DAYS) {
    WORD_DATA[d].words.forEach(w => {
      if (state.difficult[d+"-"+w.h]) all.push({ ...w, day: d });
    });
  }
  return all;
}
function toggleDifficult() {
  const w = getCurrent(); if (!w) return;
  const day = state.mode === "listening" ? w.day : state.day;
  const key = day + "-" + w.h;
  if (state.difficult[key]) { delete state.difficult[key]; }
  else { state.difficult[key] = { day, h:w.h, r:w.r, m:w.m, k:w.k||"" }; }
  saveDifficult(); render();
}
function getLearnedWords() {
  const all = [];
  for (const d of DAYS) {
    WORD_DATA[d].words.forEach(w => {
      if (state.bookmarks[d+"-"+w.h]) all.push({ ...w, day: d });
    });
  }
  return all;
}
function getLearnedCount() {
  return Object.keys(state.bookmarks).length;
}
function startListeningLearned() {
  const all = getLearnedWords();
  if (all.length === 0) { alert("ì™¸ìš´ ë‹¨ì–´ê°€ ì—†ì–´ìš”!\ní•™ìŠµ ì¤‘ âœ“ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”."); return; }
  for (let i = all.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [all[i], all[j]] = [all[j], all[i]];
  }
  state.listenWords = all; state.listenIdx = 0;
  state.listenType = "learned";
  state.mode = "listening"; state.showMeaning = false;
  pushMode("listening");
  stopAuto(); render();
  setTimeout(() => speakOnce(), 300);
}
function startListening() {
  const all = getDifficultWords();
  if (all.length === 0) { alert("ì–´ë ¤ìš´ ë‹¨ì–´ê°€ ì—†ì–´ìš”!\ní•™ìŠµ ì¤‘ â˜…ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”."); return; }
  for (let i = all.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [all[i], all[j]] = [all[j], all[i]];
  }
  state.listenWords = all; state.listenIdx = 0;
  state.listenType = "difficult";
  state.mode = "listening"; state.showMeaning = false;
  pushMode("listening");
  stopAuto(); render();
  setTimeout(() => speakOnce(), 300);
}

// === ì˜¤ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ===
const ttsAudio = new Audio();
let ttsPlaying = false;
let speakSeq = 0;

// setTimeout ê¸°ë°˜ ë”œë ˆì´
function playDelayAudio(delayMs, callback) {
  setTimeout(() => { if (callback) callback(); }, delayMs);
}

// === TTS BLOB ìºì‹œ ===
// Google TTSë¥¼ Blobìœ¼ë¡œ ë¯¸ë¦¬ ë‹¤ìš´ë¡œë“œ â†’ í™”ë©´ êº¼ì ¸ë„ ë„¤íŠ¸ì›Œí¬ ì—†ì´ ì¬ìƒ ê°€ëŠ¥
let ttsBlobs = {}; // text -> blobUrl

function prefetchTTS(text) {
  if (!text || ttsBlobs[text]) return;
  const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=ja&client=tw-ob&q=${encodeURIComponent(text)}`;
  fetch(url).then(r => r.blob()).then(blob => {
    ttsBlobs[text] = URL.createObjectURL(blob);
  }).catch(() => {});
}

function getNextWordText() {
  const isListen = state.mode === "listening";
  const words = isListen ? state.listenWords : getWords();
  const idx = isListen ? state.listenIdx : state.idx;
  const w = words[idx + 1];
  if (!w) return null;
  return w.h.includes(" / ") ? w.h.split(" / ")[0] : w.h;
}

function clearTTSCache() {
  Object.values(ttsBlobs).forEach(u => URL.revokeObjectURL(u));
  ttsBlobs = {};
}

// === TTS ===
function cancelSpeak() {
  speakSeq++;
  window.speechSynthesis?.cancel();
  ttsAudio.pause();
  ttsAudio.onended = null;
  ttsAudio.onerror = null;
  ttsPlaying = false;
  state.exSpeaking = false;
}

function speakGoogleTTS(text, cb) {
  cancelSpeak();
  const mySeq = ++speakSeq;
  let done = false;
  ttsPlaying = true;
  const onDone = (fallback) => {
    if (done || mySeq !== speakSeq) return;
    done = true;
    ttsPlaying = false;
    // ë°±ê·¸ë¼ìš´ë“œì—ì„œëŠ” speakLocal ìŠ¤í‚µ (SpeechSynthesis + setTimeout ë‘˜ ë‹¤ ì•ˆ ë¨)
    if (fallback && document.visibilityState === 'visible') speakLocal(text, cb);
    else if (cb) cb();
  };

  // ë‹¤ìŒ ë‹¨ì–´ í”„ë¦¬í˜ì¹˜ (í˜„ì¬ ì¬ìƒ ì¤‘ì— ë¯¸ë¦¬ ë‹¤ìš´ë¡œë“œ)
  prefetchTTS(getNextWordText());

  ttsAudio.onended = () => onDone(false);
  ttsAudio.onerror = () => onDone(true);
  ttsAudio.loop = false;
  ttsAudio.volume = 1.0;
  ttsAudio.playbackRate = state.speed;

  // ìºì‹œëœ Blobì´ ìˆìœ¼ë©´ ì‚¬ìš© (ë„¤íŠ¸ì›Œí¬ ë¶ˆí•„ìš” â†’ ë°±ê·¸ë¼ìš´ë“œ OK)
  const directUrl = `https://translate.google.com/translate_tts?ie=UTF-8&tl=ja&client=tw-ob&q=${encodeURIComponent(text)}`;
  if (ttsBlobs[text]) {
    ttsAudio.src = ttsBlobs[text];
    ttsAudio.play().catch(() => onDone(true));
  } else {
    // ì²« ì¬ìƒ: ì§ì ‘ URLë¡œ ì¬ìƒ + ë™ì‹œì— Blob ìºì‹œ (ë°˜ë³µ ì¬ìƒìš©)
    ttsAudio.src = directUrl;
    ttsAudio.play().catch(() => onDone(true));
    fetch(directUrl).then(r => r.blob()).then(blob => {
      if (!ttsBlobs[text]) ttsBlobs[text] = URL.createObjectURL(blob);
    }).catch(() => {});
  }
}

// SpeechSynthesis (í¬ê·¸ë¼ìš´ë“œ í´ë°± ì „ìš©)
function speakLocal(text, cb) {
  if (!window.speechSynthesis) { if(cb) cb(); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ja-JP"; u.rate = state.speed;
  const voices = window.speechSynthesis.getVoices();
  const jpVoice = voices.find(v => v.lang.startsWith("ja"));
  if (jpVoice) u.voice = jpVoice;
  let done = false;
  const finish = () => { if (done) return; done = true; if (cb) cb(); };
  u.onend = finish;
  u.onerror = finish;
  window.speechSynthesis.speak(u);
  setTimeout(() => { if (!done && !window.speechSynthesis.speaking) finish(); }, 3000);
}

// TTS ë˜í¼ (ìµœì†Œ ì¬ìƒ ì‹œê°„ ë³´ì¥)
function speak(text, cb) {
  const t0 = Date.now();
  const minMs = Math.max(500, text.length * 150 / state.speed);
  const safeCb = cb ? () => {
    const d = Date.now() - t0;
    if (d < minMs) playDelayAudio(minMs - d, cb);
    else cb();
  } : null;
  speakGoogleTTS(text, safeCb);
}

// í•œêµ­ì–´ TTS (Google TTS, tl=ko) + SpeechSynthesis í´ë°±
function speakKo(text, cb) {
  cancelSpeak();
  const mySeq = ++speakSeq;
  let done = false;
  ttsPlaying = true;
  // [í’ˆì‚¬] íƒœê·¸ ì œê±° â†’ ê¹”ë”í•œ í•œêµ­ì–´ë§Œ TTSì— ì „ë‹¬
  const clean = text.replace(/^\[.*?\]\s*/, '');
  const onDone = (fallback) => {
    if (done || mySeq !== speakSeq) return;
    done = true;
    ttsPlaying = false;
    if (fallback && document.visibilityState === 'visible') {
      speakLocalKo(clean, cb);
    } else if (cb) cb();
  };
  ttsAudio.onended = () => onDone(false);
  ttsAudio.onerror = () => onDone(true);
  ttsAudio.loop = false;
  ttsAudio.volume = 1.0;
  ttsAudio.playbackRate = state.speed;
  const cacheKey = "ko:" + clean;
  const directUrl = `https://translate.google.com/translate_tts?ie=UTF-8&tl=ko&client=tw-ob&q=${encodeURIComponent(clean)}`;
  if (ttsBlobs[cacheKey]) {
    ttsAudio.src = ttsBlobs[cacheKey];
    ttsAudio.play().catch(() => onDone(true));
  } else {
    ttsAudio.src = directUrl;
    ttsAudio.play().catch(() => onDone(true));
    fetch(directUrl).then(r => r.blob()).then(blob => {
      if (!ttsBlobs[cacheKey]) ttsBlobs[cacheKey] = URL.createObjectURL(blob);
    }).catch(() => {});
  }
}

// SpeechSynthesis í•œêµ­ì–´ í´ë°± (í¬ê·¸ë¼ìš´ë“œ ì „ìš©)
function speakLocalKo(text, cb) {
  if (!window.speechSynthesis) { if (cb) cb(); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ko-KR"; u.rate = state.speed;
  const voices = window.speechSynthesis.getVoices();
  const koVoice = voices.find(v => v.lang.startsWith("ko"));
  if (koVoice) u.voice = koVoice;
  let done = false;
  const finish = () => { if (done) return; done = true; if (cb) cb(); };
  u.onend = finish;
  u.onerror = finish;
  window.speechSynthesis.speak(u);
  setTimeout(() => { if (!done && !window.speechSynthesis.speaking) finish(); }, 3000);
}

// Preload voices (í´ë°±ìš©)
if (window.speechSynthesis) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
}

// í™”ë©´ êº¼ì§€ë©´ ìë™ì¬ìƒ ì •ì§€
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden' && state.playing) {
    stopAuto();
    render();
  }
});

// === AUTO PLAY ===
function stopAuto() {
  state.playing = false; state.playCount = 0;
  playId++;
  cancelSpeak();
  clearTTSCache();
}

function autoPlayStart() { return state.speakKorean ? -1 : 0; }

function autoPlay(count) {
  const myId = playId;
  if (!state.playing) return;
  const isListen = state.mode === "listening";
  const words = isListen ? state.listenWords : getWords();
  const idx = isListen ? state.listenIdx : state.idx;

  // count === -1: í•œêµ­ì–´ ëœ» ë¨¼ì € ë§í•˜ê¸°
  if (count === -1) {
    const w = words[idx];
    if (!w) { stopAuto(); render(); return; }

    speakKo(w.m, () => {
      if (!state.playing || playId !== myId) return;
      playDelayAudio(600, () => {
        if (!state.playing || playId !== myId) return;
        autoPlay(0);
      });
    });
    return;
  }

  if (count >= state.repeatCount) {
    state.playCount = 0;
    playDelayAudio(400, () => {
      if (playId !== myId || !state.playing) return;
      if (idx < words.length - 1) {
        if (isListen) state.listenIdx++; else state.idx++;
        state.slideDir = "left"; render(); autoPlay(autoPlayStart());
      } else { stopAuto(); render(); }
    });
    return;
  }
  state.playCount = count + 1;
  render();
  const w = words[idx];
  if (!w) { stopAuto(); render(); return; }
  const text = w.h.includes(" / ") ? w.h.split(" / ")[0] : w.h;
  speak(text, () => {
    if (!state.playing || playId !== myId) return;
    playDelayAudio(state.repeatDelay, () => {
      if (!state.playing || playId !== myId) return;
      autoPlay(count + 1);
    });
  });
}

async function togglePlay() {
  if (state.playing) { stopAuto(); }
  else {
    state.playing = true;
    render();
    autoPlay(autoPlayStart());
  }
  render();
}

// === TEST ===
function startTest() {
  // ì•„ì§ ì™¸ìš°ì§€ ì•Šì€ ë‹¨ì–´(learnedì— ì—†ëŠ” ë‹¨ì–´)ë¥¼ í…ŒìŠ¤íŠ¸
  const all = [];
  for (const d of DAYS) {
    WORD_DATA[d].words.forEach(w => {
      if (!state.bookmarks[d+"-"+w.h]) all.push({ day:d, h:w.h, r:w.r, m:w.m, cnt:1 });
    });
  }
  if (all.length === 0) { alert("ëª¨ë“  ë‹¨ì–´ë¥¼ ì™¸ì› ì–´ìš”! ğŸ‰"); return; }
  // ëœë¤ ì…”í”Œ
  for (let i = all.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [all[i], all[j]] = [all[j], all[i]];
  }
  state.mode = "test"; state.testWords = all; state.testIdx = 0;
  state.testRevealed = false; state.testScore = { correct:0, wrong:0 };
  pushMode("test");
  stopAuto(); render();
}

function testAnswer(correct) {
  const w = state.testWords[state.testIdx];
  const key = bmKey(w, w.day);
  if (correct) {
    state.testScore.correct++;
    // ë§íŒ ë‹¨ì–´ëŠ” learnedì— ì¶”ê°€
    state.bookmarks[key] = { day:w.day, h:w.h, r:w.r, m:w.m, cnt:1 };
  } else {
    state.testScore.wrong++;
    // í‹€ë¦° ë‹¨ì–´ëŠ” learnedì—ì„œ ì œê±° (ì•ˆ ì™¸ìš´ ìƒíƒœ ìœ ì§€)
    delete state.bookmarks[key];
  }
  saveBookmarks();
  if (state.testIdx < state.testWords.length - 1) {
    state.testIdx++; state.testRevealed = false;
  } else { state.mode = "result"; }
  render();
}

// === SWIPE & TAP ===
let touchSX = 0, touchEX = 0, touchSY = 0, touchMoved = false;
function onTS(e) { touchSX = e.touches[0].clientX; touchSY = e.touches[0].clientY; touchEX = touchSX; touchMoved = false; }
function onTM(e) { touchEX = e.touches[0].clientX; if (Math.abs(touchEX - touchSX) > 10) touchMoved = true; }
function onTE(e) {
  const d = touchSX - touchEX;
  if (Math.abs(d) > 60) { d > 0 ? goNext() : goPrev(); return; }
  // Tap: ìŠ¤ì™€ì´í”„ ì•„ë‹Œ ê²½ìš° ì¹´ë“œ ì¢Œ/ìš° ì˜ì—­ íƒ­ìœ¼ë¡œ ì´ë™
  // ìƒë‹¨ 70pxì€ ì²´í¬ë²„íŠ¼/ìŠ¤í”¼ì»¤ ì˜ì—­ì´ë¯€ë¡œ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ì œì™¸
  if (!touchMoved) {
    const card = e.currentTarget;
    const rect = card.getBoundingClientRect();
    const y = touchSY - rect.top;
    if (y < 70) return;
    const x = touchSX - rect.left;
    if (x < rect.width * 0.35) goPrev();
    else if (x > rect.width * 0.65) goNext();
  }
}
function goNext() {
  if (state.mode === "test") {
    if (state.testIdx < state.testWords.length - 1) { state.testIdx++; state.testRevealed = false; state.slideDir = "left"; render(); }
    return;
  }
  if (state.mode === "listening") {
    if (state.listenIdx < state.listenWords.length - 1) {
      const wasPlaying = state.playing;
      if (wasPlaying) { playId++; cancelSpeak(); }
      state.listenIdx++; state.playCount = 0; state.slideDir = "left"; render();
      if (wasPlaying) autoPlay(autoPlayStart()); else speakOnce();
    }
    return;
  }
  const words = getWords();
  if (state.idx < words.length - 1) {
    const wasPlaying = state.playing;
    if (wasPlaying) { playId++; cancelSpeak(); }
    state.idx++; state.playCount = 0; state.slideDir = "left"; render();
    if (wasPlaying) autoPlay(autoPlayStart());
  }
}
function goPrev() {
  if (state.mode === "test") {
    if (state.testIdx > 0) { state.testIdx--; state.testRevealed = false; state.slideDir = "right"; render(); }
    return;
  }
  if (state.mode === "listening") {
    if (state.listenIdx > 0) {
      const wasPlaying = state.playing;
      if (wasPlaying) { playId++; cancelSpeak(); }
      state.listenIdx--; state.playCount = 0; state.slideDir = "right"; render();
      if (wasPlaying) autoPlay(autoPlayStart()); else speakOnce();
    }
    return;
  }
  if (state.idx > 0) {
    const wasPlaying = state.playing;
    if (wasPlaying) { playId++; cancelSpeak(); }
    state.idx--; state.playCount = 0; state.slideDir = "right"; render();
    if (wasPlaying) autoPlay(autoPlayStart());
  }
}

// === KEYBOARD ===
document.addEventListener("keydown", e => {
  if (e.key === "ArrowRight") goNext();
  if (e.key === "ArrowLeft") goPrev();
  if (e.key === " ") { e.preventDefault(); togglePlay(); }
});

// === ìƒˆë¡œê³ ì¹¨ ===
function doRefresh() { location.reload(); }

// === RENDER ===
function render() {
  const app = document.getElementById("app");
  const w = getCurrent();
  const words = getWords();

  let html = "";

  // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ëª¨ë“œ
  if (state.mode === "categories") {
    html += `<div class="menu-header" style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="menu-header-title">æ—¥æœ¬èª ë‹¨ì–´ì¥ <span style="font-size:10px;color:var(--muted);font-weight:400;letter-spacing:0">${APP_VERSION}</span></div>
        <div class="menu-header-sub">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš” Â· ì´ ${Object.values(WORD_DATA).reduce((s,d)=>s+d.words.length,0)}ë‹¨ì–´</div>
      </div>
      <button class="refresh-btn" style="font-size:22px;margin-top:4px" onclick="doRefresh()">â†»</button>
    </div>`;
    html += `<div class="menu-list">`;
    // ë“£ê¸°í€´ì¦ˆ (ì™¸ìš´ ë‹¨ì–´)
    const lnCount = getLearnedCount();
    html += `<div class="cat-item" onclick="startListeningLearned()" style="border-color:rgba(0,210,211,.2)">
      <div>
        <div class="cat-title" style="color:var(--success)">ğŸ§ ì™¸ìš´ ë‹¨ì–´ í€´ì¦ˆ</div>
        <div class="cat-sub">ì™¸ìš´ ë‹¨ì–´ ë“£ê¸° ì—°ìŠµ Â· âœ“ ${lnCount}ë‹¨ì–´</div>
      </div>
      <div class="cat-badge" style="background:rgba(0,210,211,.15);color:var(--success)">${lnCount}</div>
    </div>`;
    // ë“£ê¸°í€´ì¦ˆ (ì–´ë ¤ìš´ ë‹¨ì–´)
    const dfCount = getDifficultCount();
    html += `<div class="cat-item" onclick="startListening()" style="border-color:rgba(255,215,0,.2)">
      <div>
        <div class="cat-title" style="color:#ffd700">ğŸ§ ì–´ë ¤ìš´ ë‹¨ì–´ í€´ì¦ˆ</div>
        <div class="cat-sub">ì–´ë ¤ìš´ ë‹¨ì–´ ë“£ê¸° ì—°ìŠµ Â· â˜… ${dfCount}ë‹¨ì–´</div>
      </div>
      <div class="cat-badge" style="background:rgba(255,215,0,.15);color:#ffd700">${dfCount}</div>
    </div>`;
    CATEGORIES.forEach((cat, ci) => {
      const totalW = cat.days.reduce((s,d) => s + (WORD_DATA[d]?.words.length||0), 0);
      const learnedW = cat.days.reduce((s,d) => {
        return s + (WORD_DATA[d]?.words.filter(w => state.bookmarks[d+"-"+w.h]).length||0);
      }, 0);
      const pct = totalW > 0 ? Math.round(learnedW/totalW*100) : 0;
      const badgeClass = pct === 100 ? "cat-badge clean" : "cat-badge";
      const badgeText = pct === 100 ? "ì™„ë£Œ" : pct + "%";
      html += `<div class="cat-item" onclick="openCategory(${ci})">
        <div>
          <div class="cat-title">${cat.title}</div>
          <div class="cat-sub">${cat.subtitle} Â· ${cat.days.length}ì¼ Â· ${totalW}ë‹¨ì–´</div>
        </div>
        <div class="${badgeClass}">${badgeText}</div>
      </div>`;
    });
    html += `</div>`;
    app.innerHTML = html;
    document.getElementById("settings-root").innerHTML = "";
    return;
  }

  // ë©”ë‰´ ëª¨ë“œ (DAY ëª©ë¡)
  if (state.mode === "menu") {
    const cat = CATEGORIES[state.catIdx];
    const catDays = cat.days;
    html += `<div class="menu-header" style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="display:flex;align-items:center;gap:8px">
          <button onclick="goCategories()" style="background:none;border:none;color:var(--accent);font-size:20px;cursor:pointer;font-weight:900">â—€</button>
          <div class="menu-header-title">${cat.title}</div>
        </div>
        <div class="menu-header-sub" style="margin-left:28px">DAYë¥¼ ì„ íƒí•˜ì„¸ìš” Â· ${catDays.reduce((s,d)=>s+(WORD_DATA[d]?.words.length||0),0)}ë‹¨ì–´</div>
      </div>
      <button class="refresh-btn" style="font-size:22px;margin-top:4px" onclick="doRefresh()">â†»</button>
    </div>`;
    html += `<div class="menu-list">`;
    for (const d of catDays) {
      const data = WORD_DATA[d];
      if (!data) continue;
      const total = data.words.length;
      const learnedCnt = data.words.filter(w => state.bookmarks[d + "-" + w.h]).length;
      const badgeClass = learnedCnt === total ? "menu-badge clean" : "menu-badge";
      const badgeText = learnedCnt === total ? "ì™„ë£Œ" : "âœ“ " + learnedCnt + "/" + total;
      html += `<div class="menu-item" onclick="openDay(${d})">
        <div class="menu-item-left">
          <div class="menu-day">DAY ${d}</div>
          <div class="menu-title">${data.title}</div>
        </div>
        <div class="${badgeClass}">${badgeText}</div>
      </div>`;
    }
    // ì¹´í…Œê³ ë¦¬ ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼
    html += `<div style="padding:16px 0 8px;display:flex;gap:8px;justify-content:center">
      <button onclick="resetCatLearned()" style="background:none;border:1px solid rgba(0,210,211,.3);color:var(--success);border-radius:8px;padding:6px 14px;cursor:pointer;font-size:12px">âœ“ ì™¸ìš´ ë‹¨ì–´ ì „ì²´ ì´ˆê¸°í™”</button>
      <button onclick="resetCatDifficult()" style="background:none;border:1px solid rgba(255,215,0,.3);color:#ffd700;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:12px">â˜… ì–´ë ¤ìš´ ë‹¨ì–´ ì „ì²´ ì´ˆê¸°í™”</button>
    </div>`;
    html += `</div>`;
    app.innerHTML = html;
    document.getElementById("settings-root").innerHTML = "";
    return;
  }

  // Header
  if (state.mode === "listening") {
    html += `<div class="header">
      <div>
        <button onclick="goCategories()" style="background:none;border:none;color:var(--accent);font-size:24px;cursor:pointer;padding:0 8px 0 0;font-weight:900">â—€</button>
        <span class="logo" style="color:${state.listenType==='learned'?'var(--success)':'#ffd700'}">ğŸ§</span><span class="logo-sub">${state.listenType==='learned'?'ì™¸ìš´ ë‹¨ì–´ í€´ì¦ˆ':'ì–´ë ¤ìš´ ë‹¨ì–´ í€´ì¦ˆ'}</span>
      </div>
      <button class="refresh-btn" onclick="doRefresh()">â†»</button>
    </div>`;
    html += `<div class="info">${state.listenType==='learned'?'ì™¸ìš´ ë‹¨ì–´':'ì–´ë ¤ìš´ ë‹¨ì–´'} Â· ${state.listenIdx+1}/${state.listenWords.length}</div>`;
  } else {
    html += `<div class="header">
      <div>
        <button onclick="goMenu()" style="background:none;border:none;color:var(--accent);font-size:24px;cursor:pointer;padding:0 8px 0 0;font-weight:900">â—€</button>
        <span class="logo">æ—¥æœ¬èª</span><span class="logo-sub">ë‹¨ì–´ì¥</span>
      </div>
      <div>
        <button class="test-btn ${unlearnedCount()===0?'disabled':''}" onclick="startTest()">í…ŒìŠ¤íŠ¸ (${unlearnedCount()})</button>
        <button class="refresh-btn" onclick="doRefresh()">â†»</button>
      </div>
    </div>`;
  }

  if (state.mode === "study") {
    // Info
    const totalWordsCount = getAllWords().length;
    const infoCount = state.hideLearned && words.length < totalWordsCount
      ? `${words.length > 0 ? state.idx+1 : 0}/${words.length} (ì „ì²´ ${totalWordsCount})`
      : `${state.idx+1}/${words.length}`;
    html += `<div class="info">${WORD_DATA[state.day].title} Â· ${infoCount}</div>`;
  }

  if (state.mode === "test") {
    html += `<div class="test-header">
      <button class="back-link" onclick="backToStudy()">â† ëŒì•„ê°€ê¸°</button>
      <span style="font-size:13px;color:var(--muted)">${state.testIdx+1}/${state.testWords.length} Â· âœ“${state.testScore.correct} âœ—${state.testScore.wrong}</span>
    </div>`;
  }

  if (state.mode === "result") {
    html += `<div class="result-page">
      <div class="result-emoji">ğŸŒ</div>
      <div class="result-title">í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</div>
      <div class="result-scores">
        <span style="color:var(--success)">âœ“ ${state.testScore.correct}</span>
        <span style="color:var(--accent)">âœ— ${state.testScore.wrong}</span>
      </div>
      <div class="result-hint">í‹€ë¦° ë‹¨ì–´ëŠ” ê°€ì¤‘ì¹˜ê°€ ì˜¬ë¼ê°€ì„œ<br>ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì—ì„œ ë” ìì£¼ ë‚˜ì™€ìš”</div>
      <div class="result-btns">
        <button class="result-retry" onclick="startTest()">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸</button>
        <button class="result-back" onclick="backToStudy()">í•™ìŠµìœ¼ë¡œ</button>
      </div>
    </div>`;
    app.innerHTML = html;
    return;
  }

  // ì™¸ìš´ ë‹¨ì–´ ìˆ¨ê¸°ê¸° ON + ëª¨ë“  ë‹¨ì–´ ì™¸ì›€ â†’ ì•ˆë‚´ ë©”ì‹œì§€
  if (!w && state.mode === "study" && state.hideLearned && getAllWords().length > 0) {
    html += `<div class="card-area" style="justify-content:center;text-align:center">
      <div style="font-size:36px;margin-bottom:12px">ğŸ‰</div>
      <div style="font-size:16px;color:var(--text);font-weight:500">ëª¨ë“  ë‹¨ì–´ë¥¼ ì™¸ì› ì–´ìš”!</div>
      <div style="font-size:13px;color:var(--muted);margin-top:8px">ì„¤ì •ì—ì„œ 'ì™¸ìš´ ë‹¨ì–´ ìˆ¨ê¸°ê¸°'ë¥¼ ë„ë©´<br>ì „ì²´ ë‹¨ì–´ë¥¼ ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆì–´ìš”</div>
    </div>`;
  }

  // Card
  if (w) {
    const isSmall = w.h.length > 6;
    const bmActive = (state.mode === "study") ? isBm(w) : false;
    const meaningHidden = state.mode === "test" ? !state.testRevealed : !state.showMeaning;

    const slideClass = state.slideDir ? " slide-" + state.slideDir : "";
    html += `<div class="card-area${slideClass}" ontouchstart="onTS(event)" ontouchmove="onTM(event)" ontouchend="onTE(event)">`;
    state.slideDir = "";

    // Bookmark + Difficult (study) / Difficult only (listening)
    if (state.mode === "study") {
      html += `<button class="bookmark-btn ${bmActive?'active':''}" onclick="toggleBm()">
        ${bmActive ? "âœ“" : "â—‹"}
      </button>`;
      const dfActive = isDf(w);
      html += `<button class="difficult-btn ${dfActive?'active':''}" onclick="toggleDifficult()">
        ${dfActive ? "â˜…" : "â˜†"}
      </button>`;
    }
    if (state.mode === "listening") {
      const dfActive = isDf(w, w.day);
      html += `<button class="bookmark-btn ${dfActive?'active':''}" onclick="toggleDifficult()" style="color:${dfActive?'#ffd700':'var(--muted)'}; filter:${dfActive?'drop-shadow(0 0 6px rgba(255,215,0,.4))':'none'}">
        ${dfActive ? "â˜…" : "â˜†"}
      </button>`;
    }

    // Play dots
    if (state.playing && (state.mode === "study" || state.mode === "listening")) {
      html += `<div class="play-dots">
        ${Array.from({length:state.repeatCount},(_,i) => `<div class="dot ${i<state.playCount?'filled':''}"></div>`).join("")}
      </div>`;
    }


    // ë©”ì¸ í…ìŠ¤íŠ¸ + ì½ê¸° í‘œê¸° (í•œì ìˆìœ¼ë©´ í•œìê°€ í¬ê²Œ, íˆë¼ê°€ë‚˜ê°€ ì‘ê²Œ)
    const mainText = w.k || w.h;
    const mainFs = isSmall ? Math.round(state.fsMain * 0.75) : state.fsMain;
    const readingSub = w.k ? `<div class="kanji-sub" style="font-size:${state.fsReading}px">${w.h}</div>` : '';
    html += `<div class="hiragana" style="font-size:${mainFs}px">${mainText}${readingSub}</div>`;

    // ì˜ˆë¬¸ (ex í•„ë“œê°€ ìˆê³  showExampleì´ trueì¼ ë•Œë§Œ)
    if (w.ex && state.showExample) {
      html += `<div class="example-area">
        <button class="example-speak${state.exSpeaking?' speaking':''}" onclick="event.stopPropagation();speakExample()" ontouchstart="event.stopPropagation()" ontouchmove="event.stopPropagation()" ontouchend="event.stopPropagation()">ğŸ”Š</button>
        <div class="example-text">
          <div class="example-jp" style="font-size:${state.fsExample}px">${w.ex}</div>
          ${w.exm ? `<div class="example-meaning" style="font-size:${state.fsExampleM}px">${w.exm}</div>` : ''}
        </div>
      </div>`;
    }

    // Bottom area (romaji + meaning + test buttons)
    html += `<div class="card-bottom">`;
    html += `<div class="romaji" style="font-size:${state.fsRomaji}px">${w.r}</div>`;
    if (state.mode === "test") {
      html += `<div class="meaning ${meaningHidden?'hidden':''}" style="font-size:${state.fsMeaning}px" onclick="revealTest()">
        ${state.testRevealed ? w.m : "íƒ­í•˜ì—¬ ëœ» í™•ì¸"}
      </div>`;
    } else {
      html += `<div class="meaning ${meaningHidden?'hidden':''}" style="font-size:${state.fsMeaning}px" onclick="toggleMeaning()">
        ${w.m}
      </div>`;
    }
    if (state.mode === "test" && state.testRevealed) {
      html += `<div class="test-actions">
        <button class="test-wrong" onclick="testAnswer(false)">âœ— ëª¨ë¥´ê² ì–´</button>
        <button class="test-correct" onclick="testAnswer(true)">âœ“ ì•Œì•„!</button>
      </div>`;
    }
    html += `</div>`;

    html += `</div>`;
  }

  // Controls (study + listening)
  if (state.mode === "study" || state.mode === "listening") {
    const speeds = [0.7, 0.85, 1.0, 1.2, 1.5];
    html += `<div class="controls">
      <div class="ctrl-col">
        <button class="gear-btn" onclick="toggleSettings()">âš™</button>
        <span class="speed-label">ì„¤ì •</span>
      </div>
      <div class="ctrl-col">
        <button class="speed-btn" onclick="cycleSpeed()">${state.speed}x</button>
        <span class="speed-label">ë°°ì†</span>
      </div>
      <button class="play-btn ${state.playing?'playing':''}" onclick="togglePlay()">
        ${state.playing ? '<span class="pause-icon"><span></span><span></span></span>' : '<span class="play-icon"></span>'}
      </button>
      <div class="ctrl-col">
        <button class="eye-btn ${state.showMeaning?'':'off'}" onclick="toggleMeaning()">ğŸ‘</button>
        <span class="speed-label">ëœ»${state.showMeaning?' ë³´ê¸°':' ìˆ¨ê¹€'}</span>
      </div>
      <div class="ctrl-col">
        <button class="eye-btn ${state.showExample?'':'off'}" onclick="toggleExample()">ä¾‹</button>
        <span class="speed-label">ì˜ˆë¬¸${state.showExample?' ë³´ê¸°':' ìˆ¨ê¹€'}</span>
      </div>
    </div>`;

    // Progress
    const isListen = state.mode === "listening";
    const pctIdx = isListen ? state.listenIdx : state.idx;
    const pctTotal = isListen ? state.listenWords.length : words.length;
    const pct = ((pctIdx + 1) / pctTotal * 100);
    html += `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>`;
  }

  // Nav
  if (state.mode === "study" || state.mode === "test" || state.mode === "listening") {
    html += `<div class="nav-row">
      <button class="nav-btn" onclick="goPrev()">â† ì´ì „</button>
      <button class="nav-btn" onclick="goNext()">ë‹¤ìŒ â†’</button>
    </div>`;
  }

  app.innerHTML = html;

  // ì„¤ì • íŒ¨ë„ (app ë°–ì— ë Œë”ë§)
  const sr = document.getElementById("settings-root");
  if (state.showSettings) {
    sr.innerHTML = `<div class="settings-overlay" onclick="closeSettings(event)">
      <div class="settings-panel" onclick="event.stopPropagation()">
        <div class="settings-title">
          ì„¤ì •
          <button class="settings-close" onclick="toggleSettings()">âœ•</button>
        </div>
        <div class="settings-row">
          <span class="settings-label">ë°˜ë³µ íšŸìˆ˜</span>
          <div class="settings-value">
            <input class="settings-input" type="number" min="1" max="10" step="1"
              value="${state.repeatCount}"
              onchange="updateRepeatCount(this.value)">
            <span class="settings-unit">íšŒ</span>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">ë°˜ë³µ ê°„ê²©</span>
          <div class="settings-value">
            <input class="settings-input" type="number" min="0" step="0.1"
              value="${(state.repeatDelay / 1000).toFixed(1)}"
              onchange="updateRepeatDelay(this.value)">
            <span class="settings-unit">ì´ˆ</span>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">ì™¸ìš´ ë‹¨ì–´ ìˆ¨ê¸°ê¸°</span>
          <div class="settings-value">
            <button style="background:${state.hideLearned?'var(--success)':'var(--day-inactive)'};color:#fff;border:none;border-radius:6px;padding:4px 14px;cursor:pointer;font-size:13px"
              onclick="toggleHideLearned()">${state.hideLearned?'ON':'OFF'}</button>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">í•œêµ­ì–´ ëœ» ì½ê¸°</span>
          <div class="settings-value">
            <button style="background:${state.speakKorean?'var(--success)':'var(--day-inactive)'};color:#fff;border:none;border-radius:6px;padding:4px 14px;cursor:pointer;font-size:13px"
              onclick="toggleSpeakKorean()">${state.speakKorean?'ON':'OFF'}</button>
          </div>
        </div>
        <div style="font-size:13px;color:var(--muted);padding:12px 0 4px;border-bottom:1px solid rgba(255,255,255,.06)">í˜„ì¬ DAY ì´ˆê¸°í™”</div>
        <div class="settings-row">
          <span class="settings-label">âœ“ ì™¸ìš´ ë‹¨ì–´ ì´ˆê¸°í™”</span>
          <div class="settings-value">
            <button style="background:var(--accent);color:#fff;border:none;border-radius:6px;padding:4px 14px;cursor:pointer;font-size:13px"
              onclick="resetDayLearned()">ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">â˜… ì–´ë ¤ìš´ ë‹¨ì–´ ì´ˆê¸°í™”</span>
          <div class="settings-value">
            <button style="background:#d4a017;color:#fff;border:none;border-radius:6px;padding:4px 14px;cursor:pointer;font-size:13px"
              onclick="resetDayDifficult()">ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div style="font-size:13px;color:var(--muted);padding:12px 0 4px;border-bottom:1px solid rgba(255,255,255,.06)">ê¸€ì”¨ í¬ê¸°</div>
        <div class="settings-row">
          <span class="settings-label">ë©”ì¸ (í•œì/ê°€ë‚˜)</span>
          <div class="settings-value">
            <input class="settings-input" type="number" min="20" max="120" step="2"
              value="${state.fsMain}"
              onchange="updateFontSize('fsMain','jp-fs-main',this.value)">
            <span class="settings-unit">px</span>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">ì½ê¸° (í›„ë¦¬ê°€ë‚˜)</span>
          <div class="settings-value">
            <input class="settings-input" type="number" min="10" max="60" step="2"
              value="${state.fsReading}"
              onchange="updateFontSize('fsReading','jp-fs-reading',this.value)">
            <span class="settings-unit">px</span>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">ë¡œë§ˆì§€</span>
          <div class="settings-value">
            <input class="settings-input" type="number" min="8" max="40" step="2"
              value="${state.fsRomaji}"
              onchange="updateFontSize('fsRomaji','jp-fs-romaji',this.value)">
            <span class="settings-unit">px</span>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">ëœ»</span>
          <div class="settings-value">
            <input class="settings-input" type="number" min="10" max="40" step="2"
              value="${state.fsMeaning}"
              onchange="updateFontSize('fsMeaning','jp-fs-meaning',this.value)">
            <span class="settings-unit">px</span>
          </div>
        </div>
        <div style="font-size:13px;color:var(--muted);padding:12px 0 4px;border-bottom:1px solid rgba(255,255,255,.06)">ì˜ˆë¬¸</div>
        <div class="settings-row">
          <span class="settings-label">ì˜ˆë¬¸ í‘œì‹œ</span>
          <div class="settings-value">
            <button style="background:${state.showExample?'var(--accent)':'var(--day-inactive)'};color:#fff;border:none;border-radius:6px;padding:4px 14px;cursor:pointer;font-size:13px"
              onclick="toggleExample()">${state.showExample?'ON':'OFF'}</button>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">ì˜ˆë¬¸ (ì¼ë³¸ì–´)</span>
          <div class="settings-value">
            <input class="settings-input" type="number" min="8" max="30" step="1"
              value="${state.fsExample}"
              onchange="updateFontSize('fsExample','jp-fs-example',this.value)">
            <span class="settings-unit">px</span>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">ì˜ˆë¬¸ (ëœ»)</span>
          <div class="settings-value">
            <input class="settings-input" type="number" min="8" max="26" step="1"
              value="${state.fsExampleM}"
              onchange="updateFontSize('fsExampleM','jp-fs-example-m',this.value)">
            <span class="settings-unit">px</span>
          </div>
        </div>
      </div>
    </div>`;
  } else {
    sr.innerHTML = "";
  }
}

// === HISTORY (ì•ˆë“œë¡œì´ë“œ ë’¤ë¡œê°€ê¸° ì§€ì›) ===
function pushMode(mode) { history.pushState({ mode }, ""); }
let skipPopstate = false;
window.addEventListener("popstate", (e) => {
  if (skipPopstate) { skipPopstate = false; return; }
  // ì„¤ì • íŒ¨ë„ ì—´ë ¤ìˆìœ¼ë©´ ë¨¼ì € ë‹«ê¸° (íˆìŠ¤í† ë¦¬ ë³µì›)
  if (state.showSettings) {
    history.pushState(e.state, "");
    state.showSettings = false; render(); return;
  }
  const target = e.state?.mode || "categories";
  stopAuto();
  state.mode = target;
  render();
});
// ì´ˆê¸° ìƒíƒœ ë“±ë¡
history.replaceState({ mode: "categories" }, "");

// === ACTIONS ===
function selectDay(d) { stopAuto(); state.day = d; state.idx = 0; state.mode = "study"; pushMode("study"); render(); }
function openDay(d) { state.day = d; state.idx = 0; state.mode = "study"; pushMode("study"); render(); }
function openCategory(ci) { state.catIdx = ci; state.mode = "menu"; pushMode("menu"); render(); }
function goCategories() { stopAuto(); state.mode = "categories"; skipPopstate = true; history.back(); render(); }
function goMenu() { stopAuto(); state.mode = "menu"; skipPopstate = true; history.back(); render(); }
function backToStudy() { stopAuto(); state.mode = "study"; skipPopstate = true; history.back(); render(); }
function toggleMeaning() { state.showMeaning = !state.showMeaning; render(); }
function toggleSettings() {
  if (!state.showSettings && state.playing) stopAuto();
  state.showSettings = !state.showSettings; render();
}
function closeSettings(e) { if (e.target === e.currentTarget) { state.showSettings = false; render(); } }
function updateRepeatCount(val) {
  const n = Math.max(1, Math.min(10, parseInt(val) || 3));
  state.repeatCount = n;
  localStorage.setItem("jp-repeat-count", n);
}
function updateRepeatDelay(val) {
  const ms = Math.max(0, Math.round(parseFloat(val) * 1000));
  state.repeatDelay = ms;
  localStorage.setItem("jp-repeat-delay", ms);
}
function updateFontSize(key, storageKey, val) {
  const n = Math.max(8, Math.min(120, parseInt(val) || state[key]));
  state[key] = n;
  localStorage.setItem(storageKey, n);
  render();
}
function revealTest() { state.testRevealed = true; render(); }
function speakOnce() {
  const w = getCurrent();
  if (w) {
    const text = w.h.includes(" / ") ? w.h.split(" / ")[0] : w.h;
    speak(text, () => {
      ttsAudio.pause();
      ttsAudio.onended = null;
      ttsAudio.onerror = null;
      ttsPlaying = false;
    });
  }
}
function speakExample() {
  const w = getCurrent();
  if (!w?.ex) return;
  stopAuto();
  state.exSpeaking = true;
  render();
  speak(w.ex, () => {
    state.exSpeaking = false;
    render();
  });
}
function toggleExample() {
  state.showExample = !state.showExample;
  localStorage.setItem("jp-show-example", state.showExample);
  render();
}
function toggleSpeakKorean() {
  state.speakKorean = !state.speakKorean;
  localStorage.setItem("jp-speak-korean", state.speakKorean);
  render();
}
function toggleHideLearned() {
  state.hideLearned = !state.hideLearned;
  localStorage.setItem("jp-hide-learned", state.hideLearned);
  // idx ë³´ì •: í•„í„°ë§ëœ ë¦¬ìŠ¤íŠ¸ì— ë§ê²Œ
  if (state.hideLearned && state.mode === "study") {
    const visible = getWords();
    if (state.idx >= visible.length) state.idx = Math.max(0, visible.length - 1);
  }
  render();
}
function resetCatLearned() {
  const cat = CATEGORIES[state.catIdx];
  let count = 0;
  cat.days.forEach(d => {
    (WORD_DATA[d]?.words || []).forEach(w => { if (state.bookmarks[d+"-"+w.h]) count++; });
  });
  if (count === 0) { alert("ì´ˆê¸°í™”í•  ì™¸ìš´ ë‹¨ì–´ê°€ ì—†ì–´ìš”."); return; }
  if (!confirm(`${cat.title} ì „ì²´\nì™¸ìš´ ë‹¨ì–´ âœ“ ${count}ê°œë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?`)) return;
  cat.days.forEach(d => {
    (WORD_DATA[d]?.words || []).forEach(w => { delete state.bookmarks[d+"-"+w.h]; });
  });
  saveBookmarks(); render();
}
function resetCatDifficult() {
  const cat = CATEGORIES[state.catIdx];
  let count = 0;
  cat.days.forEach(d => {
    (WORD_DATA[d]?.words || []).forEach(w => { if (state.difficult[d+"-"+w.h]) count++; });
  });
  if (count === 0) { alert("ì´ˆê¸°í™”í•  ì–´ë ¤ìš´ ë‹¨ì–´ê°€ ì—†ì–´ìš”."); return; }
  if (!confirm(`${cat.title} ì „ì²´\nì–´ë ¤ìš´ ë‹¨ì–´ â˜… ${count}ê°œë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?`)) return;
  cat.days.forEach(d => {
    (WORD_DATA[d]?.words || []).forEach(w => { delete state.difficult[d+"-"+w.h]; });
  });
  saveDifficult(); render();
}
function resetDayLearned() {
  const day = state.day;
  const words = WORD_DATA[day]?.words || [];
  if (words.length === 0) return;
  const count = words.filter(w => state.bookmarks[day + "-" + w.h]).length;
  if (count === 0) { alert("ì´ˆê¸°í™”í•  ì™¸ìš´ ë‹¨ì–´ê°€ ì—†ì–´ìš”."); return; }
  if (!confirm(`DAY ${day} (${WORD_DATA[day].title})\nì™¸ìš´ ë‹¨ì–´ âœ“ ${count}ê°œë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?`)) return;
  words.forEach(w => { delete state.bookmarks[day + "-" + w.h]; });
  saveBookmarks();
  state.idx = 0;
  render();
}
function resetDayDifficult() {
  const day = state.day;
  const words = WORD_DATA[day]?.words || [];
  if (words.length === 0) return;
  const count = words.filter(w => state.difficult[day + "-" + w.h]).length;
  if (count === 0) { alert("ì´ˆê¸°í™”í•  ì–´ë ¤ìš´ ë‹¨ì–´ê°€ ì—†ì–´ìš”."); return; }
  if (!confirm(`DAY ${day} (${WORD_DATA[day].title})\nì–´ë ¤ìš´ ë‹¨ì–´ â˜… ${count}ê°œë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?`)) return;
  words.forEach(w => { delete state.difficult[day + "-" + w.h]; });
  saveDifficult();
  render();
}
function toggleBm() {
  const w = getCurrent(); if (!w) return;
  const key = bmKey(w);
  const wasLearned = !!state.bookmarks[key];
  if (wasLearned) { delete state.bookmarks[key]; }
  else { state.bookmarks[key] = { day:state.day, h:w.h, r:w.r, m:w.m, cnt:1 }; }
  saveBookmarks();
  // ì™¸ìš´ ë‹¨ì–´ ìˆ¨ê¸°ê¸° ON ìƒíƒœì—ì„œ ì™¸ìš´ ì²´í¬í•˜ë©´ â†’ idx ë³´ì • + autoPlay ë¦¬ì…‹
  if (state.hideLearned && !wasLearned && state.mode === "study") {
    const wasPlaying = state.playing;
    if (wasPlaying) { playId++; cancelSpeak(); }
    const visible = getWords();
    if (visible.length === 0) { state.idx = 0; if (wasPlaying) stopAuto(); }
    else {
      if (state.idx >= visible.length) { state.idx = visible.length - 1; }
      if (wasPlaying) { state.playCount = 0; autoPlay(autoPlayStart()); }
    }
  }
  render();
}
function cycleSpeed() {
  const speeds = [0.7, 0.85, 1.0, 1.2, 1.5];
  const i = speeds.indexOf(state.speed);
  state.speed = speeds[(i + 1) % speeds.length];
  render();
}

// Init
render();
</script>
</body>
</html>
